{% extends 'layout/footer.html.twig' %}

{% block footer_main %}

    {{ parent() }}

    {% set aKlFooter = oViewConf.getKlarnaFooterContent() %}
    {% if aKlFooter.script %}
        {{ aKlFooter.script }}
    {% endif %}
    {{ script({ include: oViewConf.getModuleUrl('tcklarna', 'out/src/js/tcklarna_scripts.js'), priority: 10, dynamic: __oxid_include_dynamic }) }}

    {% if aKlFooter %}

        {% capture assign = "klFooterContent" %}
            {% if aKlFooter.url %}
                {% if oViewConf.getActiveTheme() == 'azure'  %}
                    <li class="klarna-logo">
                        <style>
                            .kl-logo {margin-top: 30px;padding: 4px 20px;}
                            .kl-logo img { max-width: 100%;}
                        </style>

                        <div class="kl-logo">
                            <div class="kl-logo-inner">
                                <img width="135" height="75" src="{{ aKlFooter.url }}">
                            </div>
                        </div>
                    </li>
                {% else %}
                    <section class="klarna-logo">
                        <style>
                            .kl-logo { margin-top: 30px; }
                            .kl-logo-inner { width: 80%; }
                            .kl-logo img { max-width: 100%;}
                        </style>

                        <div class="kl-logo">
                            <div class="{% if (aKlFooter.class is same as('logoFooter') or aKlFooter.class is same as('logoBlack') or aKlFooter.class is same as('logoWhite') ) %}kl-logo-inner{% endif %}">
                                <img {% if (aKlFooter.class is same as('logoFooter')) %}width="135" height="75"{% endif %} src="{{ aKlFooter.url }}">
                            </div>
                        </div>
                    </section>
                {% endif %}
            {% endif %}
        {% endcapture %}

        <script type="text/javascript">
            function embedKlarnaLogo(content) {
                var theme = '[{$oViewConf->getActiveTheme()}]';
                var $content = $(content)
                if(theme === 'flow'){
                    $('.footer-right-part div:first').append($content);
                }
                if(theme === 'wave'){
                    $('.footer-box-newsletter').append($content);
                }
                if(theme === 'azure'){
                    $('#footerCategories .list.categories').append($content);
                }

                // get logo in natural size
                var $img = $content.find('img');
                var parsedUrl = $img.attr('src').split('width=');
                if(parsedUrl.length > 1) {
                    var prevStyle = getComputedStyle($content.prev().children().first()[0]);
                    $img.attr('src', parsedUrl[0] + 'width=' + parseInt(prevStyle.width));
                }
            }
        </script>
        {% set klFooterContent = klFooterContent|escape("js") %}
        {{ script({ add: "embedKlarnaLogo('$klFooterContent');", dynamic: __oxid_include_dynamic }) }}
    {% endif %}

    {{ parent() }}

    {% if oViewConf.getActiveTheme() is same as('azure') %}
        {{ script({ include: "asdf", priority: 3, dynamic: __oxid_include_dynamic }) }}
    {% endif %}
    {% if oViewConf.showCheckoutTerms()  %}
        {% set klarnaLawNotifUrl = oViewConf.getLawNotificationsLinkKco() %}
        <style>
            #legalModal iframe {
                padding-top: 30px;
                width: 100%;
                border: 0;
            }

            .modal-dialog button.close {
                position: absolute;
                right: 0;
                z-index: 1;
                font-size: 30px;
                font-weight: 700;
                line-height: 1;
                color: #000;
                text-shadow: 0 1px 0 #fff;
                filter: alpha(opacity=20);
                opacity: .2;
                background-color: #fff;
                padding: 0;
                margin: 14px;
                border: none;
            }

            .modal-dialog button.close:hover {
                opacity: .7;
            }

            label {
                font-weight: normal;
            }

            .klarna-notification {
                text-decoration: underline;
                color: #009EC0;
            }

            .klarna-notification:hover {
                text-decoration: none;
                color: #008DB0;
            }
        </style>
        <div class="klarna-modal modal fade" id="legalModal" tabindex="-1" role="dialog">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <button type="button" class="btn btn-default close pull" data-dismiss="modal">&times;</button>
                    <div class="modal-body">
                        <iframe style="max-width: 660px !important; height: 500px !important;"
                                src="{{ klarnaLawNotifUrl }}" scrolling="yes"></iframe>
                    </div>
                </div>
            </div>
        </div>
        {% capture assign = "lawNoticeTemplate" %}
            <div class="klarna-law-notice">
                {% set klarnaLawNoticeMessage = "TCKLARNA_LAW_NOTICE"|translate(oViewConf.getLawNotificationsLinkKco()) %}
                {{ klarnaLawNoticeMessage }}
            </div>
        {% endcapture %}
        <script>
            if (window.addEventListener) {
                window.addEventListener('load', insertKlarnaNotifications)
            } else {
                window.attachEvent('onload', insertKlarnaNotifications)
            }

            function insertKlarnaNotifications() {

                var $noticeBox = $("{{ lawNoticeTemplate|escape("js") }}");

                // my account
                var $loginForm = $('form[name=login]');
                if ($loginForm.length > 0) {
                    $noticeBox.clone()
                        .appendTo($loginForm.find('div.checkbox:last'));
                }

                var $registerForm = $('form[name=order]');
                if ($registerForm.length && $registerForm.find('input[name=cl][value=register]').length) {
                    $noticeBox.clone()
                        .appendTo($registerForm.find('span.help-block').last());
                }

                $('a.klarna-notification').click(function (e) {
                    e.preventDefault();
                    $('#legalModal').modal('show');
                });
            }
        </script>
    {% endif %}

    {% if oViewConf.getActiveTheme() is same as('wave') %}
        <link rel="stylesheet" type="text/css" href="{{ oViewConf.getModuleUrl('tcklarna', 'out/src/css/tc_klarna_style_wave.css') }}"/>
    {% endif %}
{% endblock %}

